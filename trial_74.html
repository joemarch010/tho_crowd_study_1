<!doctype html>

<html lang="en-US">

<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <title>Experiment</title>
</head>


<body style="background: linear-gradient(to bottom, #ffffff 0%, #ffffff 100%);" onload="setup()">

    <script>

        function setup() {

            var warningText = document.getElementById("warning")
            warningText.style.color = "white";

            var currentIndex = localStorage.getItem("currentIndex");
            var trial = currentIndex
            localStorage.setItem("currentIndex", Number(currentIndex) + 1);
            var indicies = JSON.parse("[" + localStorage.getItem("indicies") + "]");

            document.getElementById('progress_text').innerText = 'Trial ' + (Number(trial) + 1).toString() + ' of ' + indicies.length.toString()
        }

        function isBlank(str) {

            return (!str || str.trim().length === 0 || str === "");
        }

        function verifyAnswers() {

            var q1Checkboxes = document.getElementsByName("check1")
            var q1OtherCheckbox = document.getElementById("q1Otherbox")
            var q1Othertext = document.getElementById("q1OtherText")
            var q1Checked = false

            q1Checkboxes.forEach((item) => {
                q1Checked = q1Checked || item.checked
            })

            if (q1Otherbox.checked && isBlank(q1Othertext.value)) {

                return false;
            }

            q1Checked = q1Checked

            var q2Checkboxes = document.getElementsByName("check1")
            var q2Checked = false

            q2Checkboxes.forEach((item) => {
                q2Checked = q2Checked || item.checked
            })


            return q1Checked && q2Checked
        }


        function getAnswer() {

            var q1Checkboxes = document.getElementsByName("check1")
            var q1OtherCheckbox = document.getElementById("q1Otherbox")
            var q1Othertext = document.getElementById("q1OtherText")
            var q1Checked = false
            var result = ""

            q1Checkboxes.forEach((item) => {
                if (item.checked && item != q1Otherbox) {
                    result = item.closest("label").textContent.trim() + ", N/A";
                }
            })

            if (result != "") {

                return result;
            }

            return "Other, " + q1Othertext.value;
            

            return "Error"
        }

        function getQ2Answer() {

            var q2Checkboxes = document.getElementsByName("check2")
            var result = ""

            q2Checkboxes.forEach((item) => {
                if (item.checked && item != q1Otherbox) {
                    result = item.closest("label").textContent.trim()
                }
            })

            return result
        }


        async function moveToNextTrial() {

            var answersValid = verifyAnswers()

            if (!answersValid) {

                var warningText = document.getElementById("warning")
                warningText.style.color = "red";
            } else {

                var currentIndex = localStorage.getItem("currentIndex");
                var indicies = JSON.parse("[" + localStorage.getItem("indicies") + "]");

                var observerID = localStorage.getItem("observerID");
                const payload = observerID + ", " + indicies[currentIndex - 1] + ", " + getAnswer() + ", " + getQ2Answer();
                const output = document.getElementById("output");

                try {
                    const response = await fetch("https://www.tonemapping-experiment-1scxxfsfe2345d3.com/index.php", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                    });

                    if (!response.ok && response != null) {
                        console.log(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log("API responded: " + JSON.stringify(data, null, 2));

                } catch (err) {
                    console.error("Fetch error:", err);
                }

                //Move
                var warningText = document.getElementById("warning")
                warningText.style.color = "white";

                console.log(currentIndex)

                if (currentIndex == indicies.length) {

                     window.location = "end.html"
                } else {

                    var nextTrial = indicies[currentIndex]
                    console.log(nextTrial)
                    var nextHTML = "trial_" + nextTrial + ".html"

                    window.location = nextHTML
                }
            }
        }

        function onlyOne(checkbox) {

            value = localStorage.getItem("indicies");

            var checkboxes = document.getElementsByName(checkbox.name)
            checkboxes.forEach((item) => {
                console.log('uncheck')
                if (item !== checkbox) item.checked = false
            })
        }
    </script>

    <div style="position: sticky; top: 0; background-color: #ffffff; margin-top: 50px;">
    <!-- <header style="text-align: center;"> -->
        <p style="text-align: center;" id="progress_text">
            
        </p>
        <hr style="width: 80%; border-color: #dddddd;"/>
    <!-- </header> -->
    </div>

    <div id="main-wrap">
    
    <!-- The main header used across all the pages of our website -->

    <div id="left-side"></div>
    <div id="content">


    <div id="wrapper">
        <figure>
            <img src=stimuli/74_ref.png alt="Reference" style="width:100%" id="img1">
            <figcaption> <b>Before</b> </figcaption>
        </figure>

        <figure>
            <img src=stimuli/74_dist.png alt="Reference" style="width:100%;" id="img1">
            <figcaption> <b>After</b> </figcaption>
        </figure>
    </div>

    <hr style="width: 80%; border-color: #dddddd;"/>


    <p style="text-align: left; font-size: 18px; margin-left: 20%;">
        <b>Question 1</b>
    </p>
    <p style="text-align: left; margin-left: calc(20% + 30px); margin-bottom: 30px; margin-right: 20%;">

        You are being shown two versions of the same photograph. Which of the following options best describes 
        the difference in how the scene content appears between “before” (left) and “after” (right)?
    </p>

    <div id="list">
        <p style="margin-left: 5%;">

            <label class="checkbox-container">Objects in the scene have changed
                <input type="checkbox" name="check1" onclick="onlyOne(this)" >
                <span class="checkmark"></span>
            </label>

            <label class="checkbox-container">Materials, colors, and/or paints of the objects in the scene have changed
                <input type="checkbox" name="check1" onclick="onlyOne(this)" >
                <span class="checkmark"></span>
            </label>

            <label class="checkbox-container"> Lighting in the scene has changed (including time of day)
                <input type="checkbox" name="check1" onclick="onlyOne(this)" >
                <span class="checkmark"></span>
            </label>

            <label class="checkbox-container">The scene appears unchanged (despite any digital image manipulation)
                <input type="checkbox" name="check1" onclick="onlyOne(this)" >
                <span class="checkmark"></span>
            </label>

            <label class="checkbox-container">Other (Please describe)
                <input type="checkbox" name="check1" id="q1Otherbox" onclick="onlyOne(this)" >
                <span class="checkmark"></span>
            </label>

            <p style="margin-left: 5%;">
                <input type="text" id="q1OtherText" size="100">
            </p>
        </p>
    </div>

    <p style="text-align: left; font-size: 18px; margin-left: 20%;">
        <b>Question 2</b>
    </p>
    <p style="text-align: left; margin-left: calc(20% + 30px); margin-bottom: 30px; margin-right: 20%;">

        Does it look like “after” (right) image is a digitally edited version of the “before” (left) image?
    </p>

    <div id="list">
        <p style="margin-left: 5%;">

            <label class="checkbox-container">Yes
                <input type="checkbox" name="check2" onclick="onlyOne(this)" >
                <span class="checkmark"></span>
            </label>

            <label class="checkbox-container">No
                <input type="checkbox" name="check2" onclick="onlyOne(this)" >
                <span class="checkmark"></span>
            </label>
        </p>
    </div>


    <hr style="width: 80%; border-color: #dddddd;"/>

    <div style="text-align: center;">
        <button type="button" onclick="moveToNextTrial()">Submit</button>
        <p id="warning" style="color: black; font-size: 14px;">
            (Please answer all questions fully)
        </p>
    </div>

    </div>
    <div id="right-side"></div>
    
    </div>
</body>

</html>